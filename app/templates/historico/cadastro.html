{% extends 'layout.html' %}
{% block title %}Cadastro de Histórico{% endblock %}
{% block content %}
        <form class="form-horizontal" method="post">
            <fieldset>

            <!-- Form Name -->
            <legend>Cadastro de Histórico</legend>

            {% if mensagem %}
            <div class="alert alert-{{tipo_mensagem}}" role="alert">{{mensagem}}</div>
            {% else %}

              <!-- Alerta obrigatoriedade -->
              <div class ="alert-info">Os campos sinalizados com asterisco (*) são obrigatórios.
              </div><br><br>

              <input type="hidden" name="items" id="items" />

              <!-- Text input-->
              <div class="form-group">
                <label class="col-md-4 control-label" for="id_veiculo">* Veículo:</label>
                <div class="col-md-5 input-group">
                  <span class="input-group-addon">
                    <span class="glyphicon">&#xe139;</span>
                  </span>
                  <input id="id_veiculo" name="id_veiculo" type="text" value="{{ model['id_veiculo'] }}" placeholder="Informe o veículo" class="form-control input-md" />
                </div>
              </div>

              <div class="form-group">
                <label class="col-md-4 control-label" for="id_cliente">* Cliente:</label>
                <div class="col-md-5 input-group">
                  <span class="input-group-addon">
                    <span class="glyphicon">&#xe139;</span>
                  </span>
                  <input id="id_cliente" name="id_cliente" type="text" value="{{ model['id_cliente'] }}" placeholder="Informe o cliente" class="form-control input-md" />
                </div>
              </div>

              <div class="form-group">
                <label class="col-md-4 control-label" for="id_tecnico">* Técnico:</label>
                <div class="col-md-5 input-group">
                  <span class="input-group-addon">
                    <span class="glyphicon">&#xe139;</span>
                  </span>
                  <input id="id_tecnico" name="id_tecnico" type="text" value="{{ model['id_tecnico'] }}" placeholder="Informe o técnico" class="form-control input-md" />
                </div>
              </div>

              <div class="form-group">
                <label class="col-md-4 control-label" for="numero_ordem">* Nº Ordem:</label>
                <div class="col-md-5 input-group">
                  <span class="input-group-addon">
                    <span class="glyphicon">&#xe139;</span>
                  </span>
                  <input id="numero_ordem" name="numero_ordem" type="text" value="{{ model['numero_ordem'] }}" placeholder="Informe o número da ordem" class="form-control input-md" readonly="readonly" />
                </div>
              </div>

              <div class="form-group">
                <label class="col-md-4 control-label" for="kilometragem">* Kilometragem:</label>
                <div class="col-md-5 input-group">
                  <span class="input-group-addon">
                    <span class="glyphicon">&#xe139;</span>
                  </span>
                  <input id="kilometragem" name="kilometragem" type="text" value="{{ model['vistoria']['kilometragem'] }}" placeholder="Informe a kilometragem" class="form-control input-md" />
                </div>
              </div>

              <div class="form-group">
                <label class="col-md-4 control-label" for="data">* Data:</label>
                <div class="col-md-5 input-group">
                  <span class="input-group-addon">
                    <span class="glyphicon">&#xe139;</span>
                  </span>
                  <input id="data" name="data" type="datetime-local" placeholder="Informe a data" class="form-control input-md" value="{{ model['data'] }}">
                </div>
              </div>

              <div class="form-group">
                <label class="col-md-4 control-label" for="tipo">* Tipo</label>
                <div class="col-md-4 input-group">
                    <span class="input-group-addon">
                      <span class="glyphicon">&#xe055;</span>
                    </span>
                    <select id="tipo" name="tipo" class="form-control input-md" required="">
                      {% for item in tupla_tipo_historico %}
                        <option value="{{ item[0] }}"
                        {{ 'selected="selected"' if (item[0] == model['tipo']) }}
                        >
                          {{ item[1] }}
                        </option>
                      {% endfor %}
                    </select>
                </div>
              </div>


              <div class="form-group">
                <label class="col-md-4 control-label" for="observacao">* Observações:</label>
                <div class="col-md-5 input-group">
                  <span class="input-group-addon">
                    <span class="glyphicon">&#xe139;</span>
                  </span>
                  <textarea id="observacao" name="observacao" placeholder="Informe as observações" class="form-control input-md">{{ model['observacao'] }}</textarea>
                </div>
              </div>


              <table id="falhas" class="table table-bordered table-striped">
                  <thead class="thead-inverse">
                      <tr>
                        <th colspan="1">Falhas</th>
                        <th>
                          <a class="btn btn-info" data-target="falha" role="button">
                          <span class="glyphicon glyphicon-plus"></span>&nbsp;
                          Inserir
                          </a>
                        </th>
                      </tr>
                      <tr>
                          <th>Descrição</th>
                          <th>Ações</th>
                      </tr>
                  </thead>
                  <tbody class="dados-tabela-falha">
                  </tbody>
              </table>

              <table id="pecas" class="table table-bordered table-striped">
                  <thead class="thead-inverse">
                      <tr>
                        <th colspan="3">Peças</th>
                        <th>
                          <a class="btn btn-info" data-target="peca" role="button">
                          <span class="glyphicon glyphicon-plus"></span>&nbsp;
                          Inserir
                          </a>
                        </th>
                      </tr>
                      <tr>
                          <th>Descrição</th>
                          <th>Qtd</th>
                          <th>Valor</th>
                          <th>Ações</th>
                      </tr>
                  </thead>
                  <tbody class="dados-tabela-peca">
                  </tbody>
              </table>

              <table id="servicos" class="table table-bordered table-striped">
                  <thead class="thead-inverse">
                      <tr>
                        <th colspan="3">Serviços</th>
                        <th>
                          <a class="btn btn-info" data-target="servico" role="button">
                          <span class="glyphicon glyphicon-plus"></span>&nbsp;
                          Inserir
                          </a>
                        </th>
                      </tr>
                      <tr>
                          <th>Descrição</th>
                          <th>Qtd</th>
                          <th>Valor</th>
                          <th>Ações</th>
                      </tr>
                  </thead>
                  <tbody class="dados-tabela-servico">
                  </tbody>
              </table>

              <template id="linha-falha-template">
                  <tr>
                      <td>
                        <input type="hidden" name="item_id_[{indice}]" value="[{id}]" />
                        <input type="hidden" name="item_ordem_[{indice}]" value="[{ordem}]" />
                        <input type="hidden" name="item_tipo_[{indice}]" value="[{tipo}]" />
                        <input type="hidden" name="item_quantidade_[{indice}]" value="[{quantidade}]" />
                        <input type="hidden" name="item_valor_[{indice}]" value="[{valor}]" />
                        <input type="text" name="item_descricao_[{indice}]" value="[{descricao}]" class="form-control input-td" required="required" />
                        <a class="btn btn-primary search-modal" data-target="{{ url_for('falha.index_ajax') }}">
                          <span class="glyphicon glyphicon-search"></span>&nbsp;
                          </a>
                      </td>
                      <td>
                          <a class="btn btn-danger">
                          <span class="glyphicon glyphicon-trash"></span>&nbsp;
                          Remover
                          </a>
                      </td>
                  </tr>
              </template>

              <template id="linha-peca-template">
                  <tr>
                      <td>
                        <input type="hidden" name="item_id_[{indice}]" value="[{id}]" />
                        <input type="hidden" name="item_ordem_[{indice}]" value="[{ordem}]" />
                        <input type="hidden" name="item_tipo_[{indice}]" value="[{tipo}]" />
                        <input type="text" name="item_descricao_[{indice}]" value="[{descricao}]" class="form-control input-td" required="required" />
                          <a class="btn btn-primary search-modal" data-target="{{ url_for('peca.index_ajax') }}">
                          <span class="glyphicon glyphicon-search"></span>&nbsp;
                          </a>
                      </td>
                      <td>
                        <input type="text" name="item_quantidade_[{indice}]" value="[{quantidade}]" class="form-control input-td" required="required" />
                      </td>
                      <td>
                        <input type="text" name="item_valor_[{indice}]" value="[{valor}]" class="form-control input-td" required="required" />
                      </td>
                      <td>
                          <a class="btn btn-danger">
                          <span class="glyphicon glyphicon-trash"></span>&nbsp;
                          Remover
                          </a>
                      </td>
                  </tr>
              </template>

              <template id="linha-servico-template">
                  <tr>
                      <td>
                        <input type="hidden" name="item_id_[{indice}]" value="[{id}]" />
                        <input type="hidden" name="item_ordem_[{indice}]" value="[{ordem}]" />
                        <input type="hidden" name="item_tipo_[{indice}]" value="[{tipo}]" />
                        <input type="text" name="item_descricao_[{indice}]" value="[{descricao}]" class="form-control input-td" required="required" />
                        <a class="btn btn-primary search-modal" data-target="{{ url_for('servico.index_ajax') }}">
                          <span class="glyphicon glyphicon-search"></span>&nbsp;
                          </a>
                      </td>
                      <td>
                        <input type="text" name="item_quantidade_[{indice}]" value="[{quantidade}]" class="form-control input-td" required="required" />
                      </td>
                      <td>
                        <input type="text" name="item_valor_[{indice}]" value="[{valor}]" class="form-control input-td" required="required" />
                      </td>
                      <td>
                          <a class="btn btn-danger">
                          <span class="glyphicon glyphicon-trash"></span>&nbsp;
                          Remover
                          </a>
                      </td>
                  </tr>
              </template>

              <div class="form-group">
                <label class="col-md-4 control-label" for="valor_total">* Valor Total:</label>
                <div class="col-md-5 input-group">
                  <span class="input-group-addon">
                    <span class="glyphicon">&#xe139;</span>
                  </span>
                  <input id="valor_total" name="valor_total" type="text" value="{{ model['valor_total'] }}" placeholder="Informe o valor total" class="form-control input-md" readonly="readonly" />
                </div>
              </div>

                            <!-- Button (Double) -->
              <div class="form-group">
                <label class="col-md-4 control-label" for="btnSalvar"></label>
                <div class="col-md-8">
                  <button id="btnSalvar" type="submit" class="btn btn-success">
                  <span class="glyphicon glyphicon-ok"></span>&nbsp;
                  Salvar
                  </button>
                  <a id="btnCancelar" type="button" class="btn btn-danger" href="{{ url_for('historico.index') }}">
                  <span class="glyphicon glyphicon-remove"></span>&nbsp;
                  Cancelar
                  </a>
                </div>
              </div>
            {% endif %}
            </fieldset>
        </form>

        <template id="modal-template">
          <div class="modal fade" id="[{id_modal}]" tabindex="-1" role="dialog" aria-labelledby="[{id_modal}]-label">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                  <h4 class="modal-title" id="[{id_modal}]-label">[{titulo}]</h4>
                </div>
                <div class="modal-body">
                  [{ conteudo }]
                </div>
                <div class="modal-footer">
                  [{ botoes }]
                </div>
              </div>
            </div>
          </div>
        </template>
        <script type="text/javascript">
            var SEPARADOR = ' / ';

            var getModelo = function(id){
                var d1 = $.Deferred();
                $.ajax({
                    url:'{{ url_for("modelo.ajax_by_id",pk='') }}'+id,
                    method:'get',
                    dataType: 'json'
                }).done(function(data){
                    d1.resolve(data.nome);
                }).fail(function(){
                    d1.resolve('');
                });
                return d1;
            };

            var getVeiculo = function(id){
                var d1 = $.Deferred();
                $.ajax({
                    url:'{{ url_for("veiculo.ajax_by_id",pk='') }}'+id,
                    method:'get',
                    dataType: 'json'
                }).done(function(data){
                    d1.resolve(data);
                }).fail(function(){
                    d1.resolve('');
                });
                return d1;
            };

            var getCliente = function(id){
                var d1 = $.Deferred();
                $.ajax({
                    url:'{{ url_for("cliente.ajax_by_id",pk='') }}'+id,
                    method:'get',
                    dataType: 'json'
                }).done(function(data){
                    d1.resolve(data.nome);
                }).fail(function(){
                    d1.resolve('');
                });
                return d1;
            };

            var getTecnico = function(id){
                var d1 = $.Deferred();
                if(id !== undefined && id !== ''){
                    $.ajax({
                        url:'{{ url_for("tecnico.ajax_by_id",pk='') }}'+id,
                        method:'get',
                        dataType: 'json'
                    }).done(function(data){
                        d1.resolve(data.nome);
                    }).fail(function(){
                        d1.resolve('');
                    });
                }else{
                    d1.resolve('');
                }
                return d1;
            };
            $("#id_cliente").selectSearch({
                findSearch:function(search, limit, offset){
                    return $.ajax({
                        url : "{{ url_for('cliente.ajax') }}",
                        dataType : "json",
                        data:'nome='+search+'&limit='+limit+'&offset='+(limit * offset)
                    });
                },
                findById:function(id){
                    return $.ajax({
                        url : "{{ url_for('cliente.ajax_by_id',pk='') }}"+id,
                        dataType : "json"
                    });
                },
                getDescription: function(data){
                    return data.id+'-'+data.nome;
                },
                getValue: function(data){
                    return data.id;
                },
                hideField:true
            });

            $("#id_veiculo").selectSearch({
                findSearch:function(search, limit, offset){
                    var d1 = $.Deferred();
                    $.ajax({
                        url : "{{ url_for('veiculo.ajax') }}",
                        dataType : "json",
                        data:'placa='+search+'&limit='+limit+'&offset='+(limit * offset)
                    }).done(function(data){
                        var listaDeferred = [];
                        var max_count = data.length;
                        var count = 0;
                        if(data.length > 0){
                            _.each(data, function(linha){
                                getModelo(linha['id_modelo']).done(function(modelo){
                                    data[count]['modelo'] = modelo;
                                    count++;
                                    if(max_count == count){
                                        d1.resolve(data);
                                    }
                                });
                            });
                        }else{
                            d1.resolve(data);
                        }
                    }).fail(function(){
                        d1.resolve('');
                    });
                    return d1;
                },
                findById:function(id){
                    var d1 = $.Deferred();
                    $.ajax({
                        url : "{{ url_for('veiculo.ajax_by_id',pk='') }}"+id,
                        dataType : "json"
                    }).done(function(data){
                        getModelo(data.id_modelo).done(function(modelo){
                            data['modelo'] = modelo;
                            d1.resolve(data);
                        });
                    }).fail(function(){
                        d1.resolve('');
                    });
                    return d1;
                },
                getDescription: function(data){
                    return data.id+SEPARADOR+data.placa+SEPARADOR+data.modelo;
                },
                getValue: function(data){
                    return data.id;
                },
                hideField:true
            });

            $("#id_tecnico").selectSearch({
                findSearch:function(search, limit, offset){
                    return $.ajax({
                        url : "{{ url_for('tecnico.ajax') }}",
                        dataType : "json",
                        data:'nome='+search+'&limit='+limit+'&offset='+(limit * offset)
                    });
                },
                findById:function(id){
                    return $.ajax({
                        url : "{{ url_for('tecnico.ajax_by_id',pk='') }}"+id,
                        dataType : "json"
                    });
                },
                getDescription: function(data){
                    return data.id+'-'+data.nome;
                },
                getValue: function(data){
                    return data.id;
                },
                hideField:true
            });
            

            var lista_falha = [];
            var lista_servico = [];
            var lista_peca = [];
            var indice = 0;
            
            $(document).ready(function(){
              //Setando Javascript dos items
              {% if model['items'] %}
                {%  for linha in model['items']  %}
                  lista_{{ get_tipo( linha['tipo'] ) }}.push(
                    {{linha|tojson|safe}}
                  );
                {% endfor %}
              {% endif %}
              //Final do carregamento dos items

              var get_item = function(tipo){
                if(tipo == 'falha'){
                  tipo = '{{ tipo_falha }}';
                }else if(tipo == 'servico'){
                  tipo = '{{ tipo_servico }}';
                }else if(tipo == 'peca'){
                  tipo = '{{ tipo_peca }}';
                }
                return {
                    "id":"",
                    "id_historico":"",
                    "ordem":"",
                    "tipo": tipo,
                    "descricao":"",
                    "quantidade":"",
                    "valor":"",
                  }
              };

              var gerar_template = function(tipo){
                return _.template( $("#linha-"+tipo+"-template").html() );
              };

              var carregar_linha = function(lista, destino, gen_template){
                var retorno = $.Deferred();
                var html_builder = '';
                var max = lista.length;
                var cont = 0;
                var resolve_template = $.Deferred();
                _.each(lista, function(linha){
                  linha['indice'] = indice
                  html_builder += gen_template(linha);
                  indice++;
                  cont++;
                  if(cont == max){
                    resolve_template.resolve();
                  }
                });
                resolve_template.done(function(){
                  $(destino).append(html_builder);
                  $("#items").val(indice);
                  retorno.resolve();
                });
                return retorno;
              }

              var carregar_falhas = function(lista){
                var destino = '.dados-tabela-falha';
                var template = gerar_template('falha');
                carregar_linha(lista, destino, template);
              };
              var carregar_servicos = function(lista){
                var destino = '.dados-tabela-servico';
                var template = gerar_template('servico');
                carregar_linha(lista, destino, template);
              };
              var carregar_pecas = function(lista){
                var destino = '.dados-tabela-peca';
                var template = gerar_template('peca');
                carregar_linha(lista, destino, template);
              };
              var get_carregar = function(tipo){
                if(tipo == 'falha'){
                  return carregar_falhas;
                }else if(tipo == 'servico'){
                  return carregar_servicos;
                }else if(tipo == 'peca'){
                  return carregar_pecas;
                }
              };

              carregar_falhas(lista_falha);
              carregar_servicos(lista_servico);
              carregar_pecas(lista_peca);

              $(document).on('click', ".btn-danger",function(e){
                $(this).closest('tr').remove();
              });
              $(document).on('click', ".btn-info",function(e){
                var tipo = $(this).data('target');
                var carregar = get_carregar(tipo);
                carregar([  get_item(tipo) ]);
              });

              // Atualizando o Valor Total
              var atualizar_valor_total = function(){
                var valor_total = 0;
                var iterate = $("table tbody tr").each(function(){
                  var $tr = $(this);
                  var quantidade = parseFloat( $tr.find('[name*="quantidade"]').val() );
                  if(!quantidade){
                    quantidade = 1;
                  }
                  var valor = parseFloat( $tr.find('[name*="valor"]').val() );
                  if(valor){
                    valor_total += (quantidade * valor);
                  }
                });
                $.when(iterate).done(function(){
                  $("#valor_total").val(valor_total);
                });
              };
              $(document).on('change', "table tbody td input",function(e){
                atualizar_valor_total();
              });
            });


            //Criação dos Modais
            var modal = function(link, callback){
              var template = _.template($("#modal-template").html());
              var id_modal = 'modalBusca';
              $.ajax({
                    url:link,
                    method:'get',
                }).done(function(data){
                var dados_modal = {
                  'id_modal': id_modal,
                  'titulo':'Busca',
                  'conteudo':data,
                  'botoes':''
                };
                $("body").append(template(dados_modal));
                $("#"+id_modal).modal();
                $('#'+id_modal).on('hidden.bs.modal', function (e) {
                  $('#'+id_modal).remove();
                });
                $('#'+id_modal).on('shown.bs.modal',callback);
              });
            };


            //Evento de busca do modal
            $(document).on('click','.search-modal',function(){
              var link = $(this).data('target');
              var $table_tr = $(this).closest('tr');
              modal(link,function(e){
                $(e.target).on('dblclick','td',function(ex){
                  var $tr = $(ex.target).closest('tr');
                  var $thead_tr = $(ex.target).closest('table').find('thead tr');
                  var dados = {};
                  $tr.find('td').each(function(index, el){
                    var $td = $(this);
                    var key = $thead_tr.children()[index].innerHTML.trim().toLowerCase();
                    dados[key] = $td.html();
                  });

                  $table_tr.trigger('update-by-modal',dados);

                  $(e.target).modal('hide');
                });
              });
            });


            //Evento ao atualizar linhas por modal
            $(document).on('update-by-modal','#falhas tr',function(e, dados){
              var $tr = $(this);
              $tr.find('[name*="descricao"]').val(dados['descrição']);
            });

            $(document).on('update-by-modal','#servicos tr',function(e, dados){
              var $tr = $(this);
              $tr.find('[name*="valor"]').val(dados['valor']);
              $tr.find('[name*="valor"]').change();
              $tr.find('[name*="descricao"]').val(dados['descrição']);
            });


            $(document).on('update-by-modal','#pecas tr',function(e, dados){
              var $tr = $(this);
              $tr.find('[name*="valor"]').val(dados['valor']);
              $tr.find('[name*="valor"]').change();
              $tr.find('[name*="descricao"]').val(dados['descrição']);
            });
        </script>
{% endblock %}
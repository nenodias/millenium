{% extends 'layout.html' %}
{% block title %}Consulta de Histórico{% endblock %}
{% block content %}
        <form class="form-horizontal">
            <fieldset>

                <!-- Form Name -->
                <legend>Consulta de Histórico</legend>
                
                <input type="hidden" id="limit" name="limit" value="10" />
                <input type="hidden" id="offset" name="offset" value="0" />
                <input type="hidden" id="sort_order" name="sort_order" value="0" />
                <input type="hidden" id="sort_direction" name="sort_direction" value="asc" />

                <!-- Search input-->
                <div class="form-group">
                    <label class="col-md-4 control-label" for="numero_ordem">N° Ordem</label>
                    <div class="col-md-5 input-group">
                        <span class="input-group-addon">
                            <span class="glyphicon">&#xe003;</span>
                        </span>
                        <input id="numero_ordem" name="numero_ordem" type="search" placeholder="Informe o n" class="form-control input-md" value="{{ model['numero_ordem'] }}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-4 control-label" for="id_cliente">Cliente</label>
                    <div class="col-md-5 input-group">
                        <span class="input-group-addon">
                            <span class="glyphicon">&#xe003;</span>
                        </span>
                        <input id="id_cliente" name="id_cliente" type="search" placeholder="Informe o cliente" class="form-control input-md" value="{{ model['id_cliente'] }}">
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label" for="id_veiculo">Veículo</label>
                    <div class="col-md-5 input-group">
                        <span class="input-group-addon">
                            <span class="glyphicon">&#xe003;</span>
                        </span>
                        <input id="id_veiculo" name="id_veiculo" type="search" placeholder="Informe o veículo" class="form-control input-md" value="{{ model['id_veiculo'] }}">
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label" for="id_tecnico">Técnico</label>
                    <div class="col-md-5 input-group">
                        <span class="input-group-addon">
                            <span class="glyphicon">&#xe003;</span>
                        </span>
                        <input id="id_tecnico" name="id_tecnico" type="search" placeholder="Informe o técnico" class="form-control input-md" value="{{ model['id_tecnico'] }}">
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label" for="data">Data</label>
                    <div class="col-md-5 input-group">
                        <span class="input-group-addon">
                            <span class="glyphicon">&#xe003;</span>
                        </span>
                        <input id="data" name="data" type="date" placeholder="Informe a data" class="form-control input-md" value="{{ model['data'] }}">
                    </div>
                </div>

                <!-- Select Basic -->
                <div class="form-group">
                    <label class="col-md-4 control-label" for="tipo">Tipo</label>
                    <div class="col-md-4 input-group">
                        <span class="input-group-addon">
                            <span class="glyphicon">&#xe003;</span>
                        </span>
                        <select id="tipo" name="tipo" class="form-control">
                            {% for item in tupla_tipo_historico %}
                                <option value="{{ item[0] }}">{{ item[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Button (Double) -->
                <div class="form-group">
                    <label class="col-md-4 control-label" for="btnPesquisar"></label>
                    <div class="col-md-8">
                        <button type="button" id="btnPesquisar" class="btn btn-primary">
                        <span class="glyphicon glyphicon-search"></span>&nbsp;
                        Pesquisar
                        </button>
                    </div>
                    <div class="col-md-12">
                        <a class="btn btn-info" role="button" href="{{ url_for('historico.form',pk=None)}}">
                        <span class="glyphicon glyphicon-plus"></span>&nbsp;
                        Inserir
                        </a>
                    </div>
                </div>
            </fieldset>
        </form>
        <hr />
        <table class="table table-bordered table-striped">
            <thead class="thead-inverse">
                <tr>
                    <th class="sortable" data-sort="id">Id</th>
                    <th>Cliente</th>
                    <th>Veículo / Placa / Modelo</th>
                    <th>Técnico</th>
                    <th class="sortable" data-sort="numero_ordem">N° Ordem</th>
                    <th class="sortable" data-sort="data">Data</th>
                    <th class="sortable" data-sort="valor_total">Valor Total</th>
                    <th>Tipo</th>
                    <th class="sortable" data-sort="">Ações</th>
                </tr>
            </thead>
            <tbody class="dados-tabela">
                
            </tbody>
        </table>
        <div class="div-paginacao">
        </div>
        <template id="linha-template">
            <tr>
                <td>[{id}]</td>
                <td>[{cliente}]</td>
                <td>[{veiculo}]</td>
                <td>[{tecnico}]</td>
                <td>[{numero_ordem}]</td>
                <td>
                    <input id="data" name="data" type="datetime-local" placeholder="Informe a data" class="form-control input-md" value="[{data}]" readonly="readonly" />
                </td>
                <td>[{valor_total}]</td>
                <td>[{tipo}]</td>
                <td>
                    <a class="btn btn-warning" href="{{url_for('historico.form')}}[{id}]">
                    <span class="glyphicon glyphicon-pencil"></span>&nbsp;
                    Editar
                    </a>
                    <a class="btn btn-danger" href="#" data-target="{{url_for('historico.delete',pk='')}}[{id}]">
                    <span class="glyphicon glyphicon-trash"></span>&nbsp;
                    Excluir
                    </a>
                    <a class="btn btn-primary" href="{{url_for('historico.report',pk='')}}[{id}]">
                    <span class="glyphicon glyphicon-print"></span>&nbsp;
                    Imprimir
                    </a>
                </td>
            </tr>
        </template>
        <template id="paginacao-template">
            <nav aria-label="...">
              <ul class="pager">
                <li><a href="#paginacao-template" class="[{prev}]" data-target="-[{limit}]">Previous</a></li>
                <li><a href="#paginacao-template" class="[{next}]" data-target="+[{limit}]">Next</a></li>
                <li class="pull-right">Total: [{count}]</li>
              </ul>
            </nav>
        </template>
        <template id="loading">
            <tr>
                <td colspan="9">
                <h4 class="text-center"> Carregando</h4>
                <div class="progress">
                  <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                    <span class="sr-only"> Carregando</span>
                  </div>
                </div>
                </td>
            </tr>
        </template>
        <template id="nenhum">
            <tr>
                <td colspan="9">
                <h4 class="text-center"> Nenhum resultado encontrado!</h4>
                </td>
            </tr>
        </template>
        <script type="text/javascript">
            var limit = 10;
            var offset = 0;

            var SEPARADOR = ' / ';

            var getModelo = function(id){
                var d1 = $.Deferred();
                $.ajax({
                    url:'{{ url_for("modelo.ajax_by_id",pk='') }}'+id,
                    method:'get',
                    dataType: 'json'
                }).done(function(data){
                    d1.resolve(data.nome);
                }).fail(function(){
                    d1.resolve('');
                });
                return d1;
            };

            var getVeiculo = function(id){
                var d1 = $.Deferred();
                $.ajax({
                    url:'{{ url_for("veiculo.ajax_by_id",pk='') }}'+id,
                    method:'get',
                    dataType: 'json'
                }).done(function(data){
                    d1.resolve(data);
                }).fail(function(){
                    d1.resolve('');
                });
                return d1;
            };

            var getCliente = function(id){
                var d1 = $.Deferred();
                $.ajax({
                    url:'{{ url_for("cliente.ajax_by_id",pk='') }}'+id,
                    method:'get',
                    dataType: 'json'
                }).done(function(data){
                    d1.resolve(data.nome);
                }).fail(function(){
                    d1.resolve('');
                });
                return d1;
            };

            var getTecnico = function(id){
                var d1 = $.Deferred();
                if(id !== undefined && id !== ''){
                    $.ajax({
                        url:'{{ url_for("tecnico.ajax_by_id",pk='') }}'+id,
                        method:'get',
                        dataType: 'json'
                    }).done(function(data){
                        d1.resolve(data.nome);
                    }).fail(function(){
                        d1.resolve('');
                    });
                }else{
                    d1.resolve('');
                }
                return d1;
            };

            var carregarDados = function(){
                var dados = $('form').serialize();
                
                var loading_tpl = _.template( $("#loading").html() );
                $('.dados-tabela').html(loading_tpl());

                var d_count = $.ajax({
                    url:'{{ url_for("historico.count") }}',
                    data: dados,
                    method:'get',
                    dataType: 'json'
                });
                var d_dados = $.ajax({
                    url:'{{ url_for("historico.ajax") }}',
                    data: dados,
                    method:'get',
                    dataType: 'json'
                });
                $.when(d_count,d_dados).then(function(r_count, retorno){
                    //Atualizando paginação
                    var retorno_count = r_count[0];
                    $('.div-paginacao').html('');
                    var template = _.template( $("#paginacao-template").html() );
                    var _count = parseInt(retorno_count['count']);
                    var _offset = parseInt($('#offset').val());
                    var _limit = parseInt($('#limit').val());
                    var _max_page = _count /_limit;
                    _max_page = parseInt(_count % _limit != 0)? _max_page + 1: _max_page;
                    retorno_count['prev'] = _offset == 0 ? 'disabled' : '';
                    retorno_count['next'] = (_offset + _limit)  >= _count ? 'disabled' : '';
                    retorno_count['limit'] - _limit;
                    $('.div-paginacao').append( template(retorno_count) );
                    //Fim da paginação

                    //Atualizando Tabela
                    var dados = retorno[0];
                    //$('.dados-tabela').html('');
                    var dados_tabela = document.createElement('tbody');
                    var loaded = $.Deferred();
                    var template = _.template( $("#linha-template").html() );
                    var max_count = dados.length;
                    var count = 0;
                    if(dados.length > 0){
                        var listaLinhas = [];
                        _.each(dados, function(linha){
                            listaLinhas.push({});
                            $.when(getVeiculo(linha['id_veiculo']), getCliente(linha['id_cliente']), getTecnico(linha['id_tecnico']) )
                            .then(function(veiculo, cliente, tecnico){
                                getModelo(veiculo['id_modelo']).done(function(modelo){
                                    linha['cliente'] = cliente;
                                    linha['tecnico'] = tecnico;
                                    linha['veiculo'] = veiculo.id +SEPARADOR+veiculo.placa+SEPARADOR+modelo;
                                    var html = template(linha);
                                    listaLinhas[dados.indexOf(linha)] = html;
                                    count++;
                                    if(max_count == count){
                                        _.each(listaLinhas,function(linha){
                                            $(dados_tabela).append(linha);
                                        });
                                        loaded.resolve('');
                                    }
                                });
                            });
                        });
                    }else{
                        var template = _.template( $("#nenhum").html() );
                        var html = template();
                        $(dados_tabela).append(html);
                    }
                    if(max_count == count){
                        loaded.resolve('');
                    }
                    loaded.done(function(){
                        $('.dados-tabela').html( $(dados_tabela).html() );
                    });
                    //Fim da Atualizacao da Tabela

                })
            };

            var eventoExcluir = function(){
                var btn = $(this);
                bootbox.confirm("Deseja excluir esse registro?", function(result) {
                    if(result){
                        $.post(btn.data('target'),function(data){
                            bootbox.alert('Registro excluído com sucesso!');
                            setTimeout(function(){
                                window.location.reload();
                            }, 2000);
                        }).fail(function(e){
                            if(e.responseText){
                                bootbox.alert(e.responseText);
                            }else{
                                bootbox.alert('Erro ao excluir registro!');
                            }
                        });
                    }
                });
            };
            var eventoPage = function(event){
                var target = event.target;
                if($(target).hasClass('disabled')){
                    event.preventDefault();
                }else{
                    var _offset = parseInt( $("#offset").val() );
                    _offset += parseInt( $(target).data('target') );
                    $("#offset").val(_offset);
                    carregarDados();
                }
            };

            $('.sortable').on('click',function(e){
                var $th = $(e.target);
                if($th.prop("tagName") != "TH"){
                    $th = $th.closest('th');
                }
                $th.parent().find('i').remove();
                var sort = $th.data('sort');
                var direction = $("#sort_direction").val();
                if( $("#sort_order").val() == sort){
                    direction = direction == 'asc' ? 'desc' : 'asc';
                    $("#sort_direction").val(direction);
                }
                var iconClass = 'pull-right glyphicon';
                    iconClass = direction == 'asc' ? iconClass+' glyphicon-triangle-bottom' : iconClass+' glyphicon-triangle-top';
                    $th.html( $th.html() + '<i class="'+iconClass+'"></i>' );
                $("#sort_order").val(sort);
                carregarDados();
            });

            $(document).ready(function(){
                carregarDados();
                $("#btnPesquisar").click(carregarDados);
                $('table').on('click','.btn-danger', eventoExcluir);
                $('.div-paginacao').on('click','.pager a', eventoPage);
            });

            $("#id_cliente").selectSearch({
                findSearch:function(search, limit, offset){
                    return $.ajax({
                        url : "{{ url_for('cliente.ajax') }}",
                        dataType : "json",
                        data:'nome='+search+'&limit='+limit+'&offset='+(limit * offset)
                    });
                },
                findById:function(id){
                    return $.ajax({
                        url : "{{ url_for('cliente.ajax_by_id',pk='') }}"+id,
                        dataType : "json"
                    });
                },
                getDescription: function(data){
                    return data.id+'-'+data.nome;
                },
                getValue: function(data){
                    return data.id;
                },
                hideField:true
            });

            $("#id_veiculo").selectSearch({
                findSearch:function(search, limit, offset){
                    var d1 = $.Deferred();
                    $.ajax({
                        url : "{{ url_for('veiculo.ajax') }}",
                        dataType : "json",
                        data:'placa='+search+'&limit='+limit+'&offset='+(limit * offset)
                    }).done(function(data){
                        var listaDeferred = [];
                        var max_count = data.length;
                        var count = 0;
                        var indice = 0;
                        if(data.length > 0){
                            _.each(data, function(linha){
                                (function(indice){
                                    getModelo(linha['id_modelo']).done(function(modelo){
                                        data[indice]['modelo'] = modelo;
                                        count++;
                                        if(max_count == count){
                                            d1.resolve(data);
                                        }
                                    });
                                })(indice);
                                indice++;
                            });
                        }else{
                            d1.resolve(data);
                        }
                    }).fail(function(){
                        d1.resolve('');
                    });
                    return d1;
                },
                findById:function(id){
                    var d1 = $.Deferred();
                    $.ajax({
                        url : "{{ url_for('veiculo.ajax_by_id',pk='') }}"+id,
                        dataType : "json"
                    }).done(function(data){
                        getModelo(data.id_modelo).done(function(modelo){
                            data['modelo'] = modelo;
                            d1.resolve(data);
                        });
                    }).fail(function(){
                        d1.resolve('');
                    });
                    return d1;
                },
                getDescription: function(data){
                    return data.id+SEPARADOR+data.placa+SEPARADOR+data.modelo;
                },
                getValue: function(data){
                    return data.id;
                },
                hideField:true
            });

            $("#id_tecnico").selectSearch({
                findSearch:function(search, limit, offset){
                    return $.ajax({
                        url : "{{ url_for('tecnico.ajax') }}",
                        dataType : "json",
                        data:'nome='+search+'&limit='+limit+'&offset='+(limit * offset)
                    });
                },
                findById:function(id){
                    return $.ajax({
                        url : "{{ url_for('tecnico.ajax_by_id',pk='') }}"+id,
                        dataType : "json"
                    });
                },
                getDescription: function(data){
                    return data.id+'-'+data.nome;
                },
                getValue: function(data){
                    return data.id;
                },
                hideField:true
            });
            $(document).on('keypress',function(e){
                var code = e.keyCode || e.which;
                if(code == 13) { //Enter keycode
                    if(!$(e.target).hasClass('nn-search')){
                        $("#btnPesquisar").click();
                    }
                }
            });
        </script>
{% endblock %}